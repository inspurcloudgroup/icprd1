# Linux进程之管理控制

####   1.1进程的查看

- `top` 能实时的查看我们系统的一些关键信息的变化: 

  <!--第一排显示-->：

  | 内容                         | 解释                                |
  | ---------------------------- | ----------------------------------- |
  | top                          | 表示当前程序的名称                  |
  | 11:05:18                     | 表示当前的系统的时间                |
  | up 8 days,17:12              | 表示该机器已经启动了多长时间        |
  | 1 user                       | 表示当前系统中只有一个用户          |
  | load average: 0.29,0.20,0.25 | 分别对应1、5、15分钟内cpu的平均负载 |

```
#查看物理CPU的个数
#cat /proc/cpuinfo |grep "physical id"|sort |uniq|wc -l

#每个cpu的核心数
cat /proc/cpuinfo |grep "physical id"|grep "0"|wc -l
```

<!--第二排显示：-->

| 内容            | 解释                |
| --------------- | ------------------- |
| Tasks: 26 total | 进程总数            |
| 1 running       | 1个正在运行的进程数 |
| 25 sleeping     | 25个睡眠的进程数    |
| 0 stopped       | 没有停止的进程数    |
| 0 zombie        | 没有僵尸进程数      |

<!--第三排显示（主要是cpu的情况）：-->

| 内容           | 解释                                                         |
| -------------- | ------------------------------------------------------------ |
| Cpu(s): 1.0%us | 用户空间进程占用CPU百分比                                    |
| 1.0% sy        | 内核空间运行占用CPU百分比                                    |
| 0.0%ni         | 用户进程空间内改变过优先级的进程占用CPU百分比                |
| 97.9%id        | 空闲CPU百分比                                                |
| 0.0%wa         | 等待输入输出的CPU时间百分比                                  |
| 0.1%hi         | 硬中断(Hardware IRQ)占用CPU的百分比                          |
| 0.0%si         | 软中断(Software IRQ)占用CPU的百分比                          |
| 0.0%st         | (Steal time) 是 hypervisor 等虚拟服务中，虚拟 CPU 等待实际 CPU 的时间的百分比 |

<!--第四排显示（主要是内存的情况）：-->

| 内容           | 解释                 |
| -------------- | -------------------- |
| 8176740 total  | 物理内存总量         |
| 8032104 used   | 使用的物理内存总量   |
| 144636 free    | 空闲内存总量         |
| 313088 buffers | 用作内核缓存的内存量 |

<!--第五排显示（主要是交换区的情况）：-->

| 内容   | 解释                                                         |
| ------ | ------------------------------------------------------------ |
| total  | 交换区总量                                                   |
| used   | 使用的交换区总量                                             |
| free   | 空闲交换区总量                                               |
| cached | 缓冲的交换区总量,内存中的内容被换出到交换区，而后又被换入到内存，但使用过的交换区尚未被覆盖 |

> **NICE 值**叫做静态优先级，是用户空间的一个优先级值，其取值范围是-20至19。这个值越小，表示进程”优先级”越高，而值越大“优先级”越低。nice值中的 -20 到 19，中 -20 优先级最高， 0 是默认的值，而 19 优先级最低 

> **PR 值**表示 Priority 值叫动态优先级，是进程在内核中实际的优先级值，进程优先级的取值范围是通过一个宏定义的，这个宏的名称是 MAX_PRIO，它的值为 140。Linux 实际上实现了 140 个优先级范围，取值范围是从 0-139，这个值越小，优先级越高。而这其中的 0 - 99 是实时进程的值，而 100 - 139 是给用户的。 

- ps 也是我们最常用的查看进程的工具之一 

  使用 `-l` 参数可以显示自己这次登陆的 bash 相关的进程信息罗列出来 

  `ps aux` 罗列出所有的进程信息 

  `ps aux | grep zsh` 查找其中的某个进程，配合 grep 和正则表达式使用 

​        `ps axjf` 查看时，将连同部分的进程呈树状显示出来 

​        `ps -afxo user,ppid,pid,pgid,command` 自定义我们所需要的参数显示 

- 通过 pstree 直接的看到相同的进程数量，最主要的还是可以看到所有进程之间的相关性。 

  ```
  pstree -up
  
  #参数选择：
  #-A  ：各程序树之间以 ASCII 字元來連接；
  #-p  ：同时列出每个 process 的 PID；
  #-u  ：同时列出每个 process 的所屬账户名称。
  ```

#### 1.2进程的管理

- ##### kill 对pid的操作（以gedit为例）

  ```
  #首先我们使用图形界面打开了 gedit，用 ps 可以查看到pid
  ps aux
  
  #使用9这个信号强制结束 gedit 进程
  kill -9 1608
  
  #我们再查找这个进程的时候就找不到了
  ps aux | grep gedit 
  ```

- #####  进程的执行顺序

  靠该进程的优先级值来判定进程调度的优先级 .

  > 而nice 的值可以通过 nice 命令来修改的，而需要注意的是 nice 值可以调整的范围是 -20 ~ 19，其中 root 有着至高无上的权力，既可以调整自己的进程也可以调整其他用户的程序，并且是所有的值都可以用，而普通用户只可以调制属于自己的进程，并且其使用的范围只能是 0 ~ 19，因为系统为了避免一般用户抢占系统资源而设置的一个限制 .

   用 renice 来修改已经存在的进程的优先级

```
renice -5 pid
```

# linux的日志系统

#### 2.1常见日志

常见的日志一般存放在 `/var/log` 中 。

根据服务对象粗略的将日志分为两类

- 系统日志：主要存放系统内置程序或系统内核之类的日志信息如 `alternatives.log` 、`btmp` 等 
- 应用日志：主要是第三方应用所产生的日志如 `tomcat7` 、`apache2` 等

| 日志名称           | 记录信息                                                     |
| ------------------ | ------------------------------------------------------------ |
| alternatives.log   | 系统的一些更新替代信息记录                                   |
| apport.log         | 应用程序崩溃信息记录                                         |
| apt/history.log    | 使用 apt-get 安装卸载软件的信息记录                          |
| apt/term.log       | 使用 apt-get 时的具体操作，如 package 的下载、打开等         |
| auth.log           | 登录认证的信息记录                                           |
| boot.log           | 系统启动时的程序服务的日志信息                               |
| btmp               | 错误的信息记录                                               |
| Consolekit/history | 控制台的信息记录                                             |
| dist-upgrade       | dist-upgrade 这种更新方式的信息记录                          |
| dmesg              | 启动时，显示屏幕上内核缓冲信息,与硬件有关的信息              |
| dpkg.log           | dpkg 命令管理包的日志。                                      |
| faillog            | 用户登录失败详细信息记录                                     |
| fontconfig.log     | 与字体配置有关的信息记录                                     |
| kern.log           | 内核产生的信息记录，在自己修改内核时有很大帮助               |
| lastlog            | 用户的最近信息记录                                           |
| wtmp               | 登录信息的记录。wtmp可以找出谁正在进入系统，谁使用命令显示这个文件或信息等 |
| syslog             | 系统信息记录                                                 |

- 在 apt 文件夹中的日志信息，其中有两个日件 `history.log` 与 `term.log`，两个日志文件的区别在于 `history.log`主要记录了进行了哪个操作，相关的依赖有哪些，而 `term.log` 则是较为具体的一些操作，主要就是下载包，打开包，安装包等等的细节操作。直接使用 less、cat、more 这样的工具来查看。

-  两个比较特殊的日志，因为这两个日志并不是 ASCII 文件而是被编码成了二进制文件，这两个日志文件是 wtmp，lastlog ，使用 last 与 lastlog 工具来提取其中的信息。

#### 2.2配置的日志

1.日志的产生方式：

- 一种是由软件开发商自己来自定义日志格式然后指定输出日志位置；
- 一种方式就是 Linux 提供的日志服务程序，而我们这里系统日志是通过 syslog 来实现，提供日志管理服务。

1.  rsyslog 的配置文件有两个：

- 一个是 `/etc/rsyslog.conf`
- 一个是 `/etc/rsyslog.d/50-default.conf`。

第一个主要是配置的环境，也就是 rsyslog 加载什么模块，文件的所属者等；而第二个主要是配置的 Filter Conditions。

**第一个配置文件：**

- rsyslog 主要是由 Input、Parser 、Output这样三个模块构成的。

- 输入—预处理器—队列— 解析、过滤—执行队列—执行处理器—输出

**第二个配置文件：**

 `Parser & Filter Engine`,它的名字叫 Selectors 是过滤 syslog 的传统方法，他主要由两部分组成，`facility` 与 `priority`，其配置格式如下 ：

```
facility.priority　　　　　log_location
```

Facility 的种类有：

| 类别     | 解释             |
| -------- | ---------------- |
| kern     | 内核消息         |
| user     | 用户信息         |
| mail     | 邮件系统消息     |
| daemon   | 系统服务消息     |
| auth     | 认证系统         |
| authpriv | 权限系统         |
| syslog   | 日志系统自身消息 |
| cron     | 计划安排         |
| news     | 新闻信息         |
| local0~7 | 由自定义程序使用 |

priority 进行优先级的划分，类别有以下几种：

| 类别          | 解释                           |
| ------------- | ------------------------------ |
| emergency     | 系统已经无法使用了             |
| alert         | 必须立即处理的问题             |
| critical      | 很严重了                       |
| error         | 错误                           |
| warning       | 警告信息                       |
| notice        | 系统正常，但是比较重要         |
| informational | 正常                           |
| debug         | debug的调试信息                |
| panic         | 很严重但是已淘汰不常用         |
| none          | 没有优先级，不记录任何日志消息 |

**`-` 代表异步写入，也就是日志写入时不需要等待系统缓存的同步，也就是日志还在内存中缓存也可以继续写入无需等待完全写入硬盘后再写入。通常用于写入数据比较大时使用。** 

3.命令 `logger`,logger 是一个 shell 命令接口，可以通过该接口使用 Syslog 的系统日志模块，还可以从命令行直接向系统日志文件写入信息。 

| 参数 | 内容                            |
| ---- | ------------------------------- |
| -i   | 在每行都记录进程 ID             |
| -t   | 添加 tag 标签                   |
| -p   | 设置日志的 facility 与 priority |

#### 2.3转储的日志

**概念：**logrotate 程序是一个日志文件管理工具。用来把旧的日志文件删除，并创建新的日志文件。我们可以根据日志文件的大小，也可以根据其天数来切割日志、管理日志，这个过程又叫做“转储”。 

**位置：**logrotate 是基于 CRON 来运行的，其脚本是 /etc/cron.daily/logrotate；同时我们可以在 `/etc/logrotate` 中找到其配置文件 。

## 代码链接:
https://github.com/inspurcloudgroup/icprd1/blob/master/%E8%AE%B8%E6%AC%A2/0526.docx

## 学习心得：

今天已经可以算是完成了linux部分的学习，目前学的也非常的浅，对于各种指令的掌握仍需要在今后的使用中多加练习，整体部分也需要不断地深入理解，对其原理方面并没有足够清晰的认识 ，流于表面的使用而已。同时对于各种命令与其参数也需要不断复习，加强熟练度。
