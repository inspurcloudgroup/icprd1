# 命令执行顺序与管道

## 命令执行顺序的控制

### 顺序执行多条命令

- 使用`;`分隔命令，可以自动顺序执行命令

### 有选择的执行命令

- 当多条顺序执行的命令之间存在依赖关系时，可以通过`&&`和`||`实现有选择的执行命令
- `&&`表示如果前面的命令执行结果（不是表示终端输出的内容，而是表示命令执行状态的结果）返回0则执行后面的，否则不执行
- `||`表示如果前面的命令执行结果返回1则执行后面的，否则不执行

- 可以通过环境变量`$?`获取上一次命令的返回结果
- `which`命令用来查找是否安装某个命令
- 示例：`which cowsay>/dev/null && echo "exist" || echo "not exist"`

### 管道

- 概念
  - 一种通信机制，通常用于进程间的通信
  - 表现出来的形式就是将前面每一个进程的输出(stdout)直接作为下一个进程的输入(stdin)

- 分类

  - 匿名管道
    - 在命令行中由`|`分隔符表示
  - 具名管道
    - 通常只会在源程序中用到具名管道

- 示例

  ```
  ls -al /etc | less
  ```
  - 过管道将前一个命令(`ls`)的输出作为下一个命令(`less`)的输入，然后就可以一行一行地看

- cut 命令，打印每一行的某一字段

  - 示例

    - 打印`/etc/passwd`文件中以`:`为分隔符的第1个字段和第6个字段分别表示用户名和其家目录

      ```
      cut /etc/passwd -d ':' -f 1,6
      ```

    - 打印`/etc/passwd`文件中每一行的前N个字符

      ```
      # 前五个（包含第五个）
      cut /etc/passwd -c -5
      # 前五个之后的（包含第五个）
      cut /etc/passwd -c 5-
      # 第五个
      cut /etc/passwd -c 5
      # 2到5之间的（包含第五个）
      cut /etc/passwd -c 2-5
      ```

- `grep`命令，在文本中或stdin中查找匹配字符串

  - 结合正则表达式可以实现很复杂却很高效的匹配和查找

  - `grep`命令的一般形式

    ```
    grep [命令选项]... 用于匹配的表达式 [文件]...
    ```

  - 示例

    - 搜索`/home/shiyanlou`目录下所有包含"shiyanlou"的文本文件，并显示出现在文本中的行号

      ```
      grep -rnI "shiyanlou" ~
      ```
      - `-r` 参数表示递归搜索子目录中的文件,`-n`表示打印匹配项行号，`-I`表示忽略二进制文件

    - 查看环境变量中以"yanlou"结尾的字符串

      ```
      export | grep ".*yanlou$"
      ```

      - 其中`$`表示一行的末尾

- `wc`命令，简单小巧的计数工具

  - 用于统计并输出一个文件中行、单词和字节的数目

  - 示例

    - 输出`/etc/passwd`文件的统计信息

      ```
      wc /etc/passwd
      ```

    - 分别只输出行数、单词数、字节数、字符数和输入文本中最长一行的字节数

      ```
      # 行数
      wc -l /etc/passwd
      # 单词数
      wc -w /etc/passwd
      # 字节数
      wc -c /etc/passwd
      # 字符数
      wc -m /etc/passwd
      # 最长行字节数
      wc -L /etc/passwd
      ```

    - 统计`/etc`下面所有目录数

      ```
      ls -dl /etc/*/ | wc -l
      ```

- sort 排序命令

  - 将输入按照一定方式排序，然后再输出

  - 支持的排序有按字典排序,数字排序，按月份排序，随机排序，反转排序，指定特定字段进行排序等等

  - 示例

    - 字典排序

      ```
      cat /etc/passwd | sort
      ```

    - 反转排序

      ```
      cat /etc/passwd | sort -r
      ```

    - 按特定字段排序

      ```
      cat /etc/passwd | sort -t':' -k 3
      ```

      - `-t`参数用于指定字段的分隔符，这里是以":"作为分隔符；`-k 字段号`用于指定对哪一个字段进行排序。这里`/etc/passwd`文件的第三个字段为数字，默认情况下是以字典序排序的，如果要按照数字排序就要加上`-n`参数

- `uniq`去重命令

  - 可以用于过滤或者输出重复行
  
  - `uniq`命令只能去连续重复的行，不是全文去重
  
  - 过滤重复行
    
    - 示例：查看历史命令并去重
    
      ```
      history | cut -c 8- | cut -d ' ' -f 1 | uniq
      ```
    
      - 使用`history`命令可以查看最近执行过的命令
      
      - 通常先排序，再去重
      
        ```
        history | cut -c 8- | cut -d ' ' -f 1 | sort | uniq
        # 或者$ history | cut -c 8- | cut -d ' ' -f 1 | sort -u
        ```
    
  - 输出重复行
  
    - 示例
  
      ```
      # 输出重复过的行（重复的只输出一个）及重复次数
      $ history | cut -c 8- | cut -d ' ' -f 1 | sort | uniq -dc
      # 输出所有重复的行
      $ history | cut -c 8- | cut -d ' ' -f 1 | sort | uniq -D
      ```

